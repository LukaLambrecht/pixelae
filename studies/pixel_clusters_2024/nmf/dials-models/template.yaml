TemplateFormatVersion: "2025-03-31"
Description: NMF model for pixel cluster occupancy
Resources:
  PixelNMF:
    Type: InferenceService::MLServer::SKLearn
    Workspace: global
    Properties:

      # general properties
      Description: Spot anomalies in the pixel cluster occupancy (barrel layers)
      Name: pixel-barrel-nmf
      Image: registry.cern.ch/docker.io/seldonio/mlserver:1.5.0
      # note: the FlaggingKey and MetricKey should correspond to one of the names in the ResponseOutput,
      #       defined in mlserver-model/app.py/postprocess!
      FlaggingKey: Flag
      MetricKey: Metric
      BuiltinThreshold: true

      # set conditions for running inference
      InferenceOnConditions:
        MinRunNumber: 396598 # only start at 2025F
        MaxRunNumber: 999999
        StableBeams: True
        FillType: PROTONS
        MinBField: 3.5
        MinEnergy: 6500
        Clock: LHC
        Sequence: GLOBAL-RUN
        L1KeyMatch: .*collisions.*
        L1MenuMatch: .*_Collisions.*_.*
        HLTConfigMatch: .*/physics/.*
        AllowedPrimaryDatasets:
          - StreamExpress
          - ZeroBias

      # extra input data from OMS
      InputMetadata:
        - Name: oms_lumisection_info
          Source: OMS
          Endpoint: lumisections
          Attributes:
            - Name: run_number
              DataType: TYPE_INT32
              Dims:
                - -1
            - Name: lumisection_number
              DataType: TYPE_INT32
              Dims:
                - -1
            - Name: pileup
              DataType: TYPE_FP32
              Dims:
                - -1
            - Name: cms_active
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: beams_stable
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: bpix_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: fpix_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: tibtid_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: tob_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: tecp_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
            - Name: tecm_ready
              DataType: TYPE_BOOL
              Dims:
                - -1
        - Name: hlt_zerobias
          Source: OMS
          Endpoint: hltpathrates
          Filter:
            - Name: path_name
              Value: HLT_ZeroBias_v\d+
              Operation: LIST_AND_MATCH
          Attributes:
            - Name: rate
              DataType: TYPE_FP32
              Dims:
                - -1

      # input data
      # update: disable BPix1, as it is too much degraded (since 2025F)
      InputSignature:
        #- Name: BPix1
        #  MonitoringElement: PixelPhase1/Phase1_MechanicalView/PXBarrel/clusters_per_SignedModuleCoord_per_SignedLadderCoord_PXLayer_1
        #  DataType: TYPE_INT32
        #  Dims:
        #    - -1
        #    - 26
        #    - 72
        - Name: BPix2
          MonitoringElement: PixelPhase1/Phase1_MechanicalView/PXBarrel/clusters_per_SignedModuleCoord_per_SignedLadderCoord_PXLayer_2
          DataType: TYPE_INT32
          Dims:
            - -1
            - 58
            - 72
        - Name: BPix3
          MonitoringElement: PixelPhase1/Phase1_MechanicalView/PXBarrel/clusters_per_SignedModuleCoord_per_SignedLadderCoord_PXLayer_3
          DataType: TYPE_INT32
          Dims:
            - -1
            - 90
            - 72
        - Name: BPix4
          MonitoringElement: PixelPhase1/Phase1_MechanicalView/PXBarrel/clusters_per_SignedModuleCoord_per_SignedLadderCoord_PXLayer_4
          DataType: TYPE_INT32
          Dims:
            - -1
            - 130
            - 72
      OutputSignature:
        - Name: Flag
          DataType: TYPE_BOOL
          Dims:
            - -1
        - Name: Metric
          DataType: TYPE_FP32
          Dims:
            - -1
      CodeUri: mlserver-model/
      Handler: app.Handler
      ModelUri: mlserver-model/pixelnmf.joblib
      Resources:
        # updated recommendation: do not set requests or limits for resources,
        # except in special cases; the default case is now handled automatically.
        Requests:
          cpu: null
          gpu: null
          memory: null
        Limits:
          cpu: null
          gpu: null
          memory: null
